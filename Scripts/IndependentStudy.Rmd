---
title: "Text Analysis of Hotel Reviews from Booking"
output: github_document
---
###In this report I perform text analysis of the publicly available review data posted on Booking for the major turistic italian cities: Milan, Rome, Florence Venice and Verona.
##Below are some of the key findings.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(here)
if(!require(knitr)) install.packages('knitr')
en_reviewResponse <- read.csv(here('Data', 'mydata.csv'), header = T)
it_reviewResponse <- read.csv(here('Data', 'mydata_it.csv'), header = T)
```

```{r, echo=FALSE}
require(devtools)
library(flipTime)
library(sqldf)
library(NLP)
library(dplyr)
library(readr)
library(tidytext)
library(tidyverse)
library(stringr)
library(tidyr)
library(scales)
library(igraph)
library(ggraph)
library(SnowballC)
library(wordcloud)
library(reshape2)
library(lubridate)
library(ggplot2)
library(widyr)
library(igraph)
library(ggraph)
library(tm)
library(tokenizers)
```
The dataset comprises `r ncol(en_reviewResponse)` columns, which are the following:
```{r}
colnames(en_reviewResponse)
```

There are `r nrow(en_reviewResponse)` english reviews in the dataset. The review date ranges from `r min(en_reviewResponse$review_date)` to `r max(en_reviewResponse$review_date)`

###Update stay date to a date format
```{r, results='hide'}
toremoveStay = c("Stayed in ")
en_reviewResponse$stay_date <- gsub(paste0(toremoveStay,collapse = "|"),"", en_reviewResponse$stay_date)

library(lubridate)
en_reviewResponse$stay_date <- as.Date(paste('01', en_reviewResponse$stay_date), format='%d %b %Y')

```


###Update review date to a date format
```{r,results='hide'}
toremove = c("Reviewed: ")

en_reviewResponse$review_date <- gsub(paste0(toremove,collapse = "|"),"", en_reviewResponse$review_date)
en_reviewResponse$review_date <- AsDate(en_reviewResponse$review_date)

```

Let's investigate which are the busiest months of the year for hotels.
```{r}
en_reviewResponse$monthStay <- format(en_reviewResponse$stay_date,'%B')

en_reviewResponse[!is.na(en_reviewResponse$monthStay),] %>% 
  ggplot(aes(x = forcats::fct_infreq(monthStay))) +
  geom_bar() + 
  scale_x_discrete(name = 'Months') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle('The number of stays per Month')
```

The highest number of weekly reviews was received within the half of 2018. The hotels received almost 1250 reviews in that week. 
```{r}
en_reviewResponse %>%
  count(Week = round_date(review_date, "week")) %>%
  ggplot(aes(Week, n)) +
  geom_line() + 
  ggtitle('The Number of Reviews Per Week')

```

###Countries with highest average score
```{r}
avgscore_nation <- sqldf('SELECT reviewer_country, avg(review_score) as avg_score from en_reviewResponse group by reviewer_country order by avg(review_score) desc')

ggplot(avgscore_nation[1:20,],aes(x=reviewer_country, y=avg_score)) + 
  geom_bar(stat = 'identity')+theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(name = 'Country') +
  scale_y_discrete(name = 'Average Score') +
  ggtitle('Countries with highest average score')
  
```


#Countries with lowest average score
```{r}
ggplot(tail(avgscore_nation, 10), aes(x=reviewer_country, y=avg_score)) + 
  geom_bar(stat = 'identity')+theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(name = 'Country') +
  scale_y_discrete(name = 'Average Score') +
  ggtitle('Countries with lowest average score')
```

Italian Average Score Nation
```{r}
it_avgScore <- avgscore_nation %>% filter(reviewer_country == 'Italy')
```

###What are the most commonly occuring words in English reviews?

```{r}
review_subject <- en_reviewResponse %>%
  unnest_tokens(word, fullText, token = "ngrams", n = 1) %>% 
  anti_join(stop_words)

prova <- review_subject %>% removeNumbers(review_subject$word, ucp = FALSE)

my_stopwords <- data_frame(word = c(as.character(1:10)))
review_subject <- review_subject %>% 
  anti_join(my_stopwords)

review_subject %>%
  count(word, sort = TRUE) %>%
  filter(n > 5000) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) +
  geom_col(fill = "lightgreen") +
  xlab(NULL) +
  coord_flip() +
  labs(title = "Most common words in review text 2017 to date",
       subtitle = "Among 87,633 reviews; stop words removed")
```

###The importance of words can be illustrated in a wordcloud.
The word cloud clearly shows that “hotel”, "location", "breakfast" and "staff" are the four most important words in Booking reviews in italian tourist cities. 
```{r}
freqWords <- review_subject %>% count(word, sort = TRUE)
set.seed(1234)
wordcloud(words = freqWords$word, freq = freqWords$n, min.freq = 1000,
          max.words=400, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))
```

###What are the most commonly occuring words in Italian reviews?
```{r}
it_review_subject <- it_reviewResponse %>%
  unnest_tokens(word, fullText, token = "ngrams", n = 1)

it_review_subject <- it_review_subject %>% 
  filter(!word %in% stopwords("italian")) %>% 
  anti_join(my_stopwords)

it_review_subject %>%
  count(word, sort = TRUE) %>%
  filter(n > 5000) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) +
  geom_col(fill = "orange") +
  xlab(NULL) +
  coord_flip() +
  labs(title = "Most common words in Italian review text 2017 to date",
       subtitle = "Among 55091 reviews; stop words removed")
```


We often want to understand the relationship between words in a review. What sequences of words are common across review text? Given a sequence of words, what word is most likely to follow? What words have the strongest relationship with each other?

###What are the most common bigrams in our reviews?
```{r, results='hide'}
review_bigrams <- en_reviewResponse %>%
  unnest_tokens(bigram, fullText, token = "ngrams", n = 2)

bigrams_separated <- review_bigrams %>%
  separate(bigram, c("word1", "word2"), sep = " ")
bigrams_filtered <- bigrams_separated %>%
  filter(!word1 %in% stop_words$word) %>%
  filter(!word2 %in% stop_words$word)

bigrams_united <- bigrams_filtered %>%
  unite(bigram, word1, word2, sep = " ")
bigrams_united %>%
  count(bigram, sort = TRUE)

```

```{r}
bigrams_united %>%
  count(bigram, sort = TRUE) %>%
  filter(n > 500) %>%
  mutate(bigram = reorder(bigram, n)) %>%
  ggplot(aes(bigram, n)) +
  geom_col(fill = "red") +
  coord_flip() +
  labs(title = "Most common bigrams in review text 2016 to date",
       subtitle = "Among 87,633 reviews")
```

The above visualizes the common bigrams in English reviews, showing those that occurred at least 500 times and where neither word was a stop-word.

#Visualize bigrams in word networks:
```{r}
title_word_pairs <- review_subject %>% 
  pairwise_count(word, reviewID, sort = TRUE, upper = FALSE)

set.seed(1234)
title_word_pairs %>%
  filter(n >= 3000) %>%
  graph_from_data_frame() %>%
  ggraph(layout = "kk") +
  geom_edge_link(aes(edge_alpha = n, edge_width = n), edge_colour = "cyan4") +
  geom_node_point(size = 5) +
  geom_node_text(aes(label = name), repel = TRUE, 
                 point.padding = unit(0.2, "lines")) +
  ggtitle('Word network in english reviews')
  
```

The network graph shows strong connections between the top several words (“friendly”, “staff”, “excellent” and “location”, "train" and "station").

###Sentiment Analysis
Sentiment analysis can be done as an inner join. Three sentiment lexicons are available via the get_sentiments() function. Let’s look at the words with a joy score from the NRC lexicon. What are the most common joy words?

```{r}
nrcjoy <- get_sentiments("nrc") %>%
  filter(sentiment == "joy")

review_subject %>%
  semi_join(nrcjoy) %>%
  count(word, sort = TRUE)
```

```{r}
bing <- get_sentiments("bing")

bing_words <- review_subject %>%
  inner_join(bing) %>%
  count(word, sentiment, sort = TRUE)
```

###Analyze word counts that contribute to each sentiment.
```{r}
bing_words %>%
  filter(n > 500) %>%
  mutate(n = ifelse(sentiment == "negative", -n, n)) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n, fill = sentiment)) +
  geom_col() +
  coord_flip() +
  labs(y = "Contribution to sentiment")
```

